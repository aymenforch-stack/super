/**
 * Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø§Ù„Ø²ÙˆØ§Ø± ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
 * Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù†: Ø¬Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø³Ù„ÙˆÙƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
 */

class VisitorTracker {
    constructor() {
        this.visitorId = null;
        this.sessionId = null;
        this.deviceInfo = {};
        this.locationInfo = {};
        this.behaviorData = [];
        this.isTracking = false;
        
        this.init();
    }
    
    init() {
        this.generateIds();
        this.collectDeviceInfo();
        this.collectNetworkInfo();
        this.startTracking();
        this.setupEventListeners();
        this.sendInitialData();
    }
    
    // ====== ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª ======
    generateIds() {
        // Ù…Ø¹Ø±Ù Ø§Ù„Ø²Ø§Ø¦Ø± (Ø¯Ø§Ø¦Ù…)
        this.visitorId = localStorage.getItem('visitor_id');
        if (!this.visitorId) {
            this.visitorId = 'visitor_' + Date.now() + '_' + this.generateRandomString(8);
            localStorage.setItem('visitor_id', this.visitorId);
        }
        
        // Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù„Ø³Ø© (ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯ ÙÙŠ ÙƒÙ„ Ø²ÙŠØ§Ø±Ø©)
        this.sessionId = 'session_' + Date.now() + '_' + this.generateRandomString(8);
        sessionStorage.setItem('session_id', this.sessionId);
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª
        this.updateVisitCount();
    }
    
    generateRandomString(length) {
        const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }
    
    updateVisitCount() {
        let visits = parseInt(localStorage.getItem('visitor_visits') || '0');
        visits++;
        localStorage.setItem('visitor_visits', visits.toString());
        
        // ÙˆÙ‚Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø£ÙˆÙ„
        if (!localStorage.getItem('first_visit')) {
            localStorage.setItem('first_visit', new Date().toISOString());
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©
        localStorage.setItem('last_visit', new Date().toISOString());
    }
    
    // ====== Ø¬Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø² ======
    collectDeviceInfo() {
        const userAgent = navigator.userAgent;
        
        this.deviceInfo = {
            // Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
            platform: navigator.platform,
            userAgent: userAgent,
            
            // Ø§Ù„Ù…ØªØµÙØ­
            browser: this.detectBrowser(userAgent),
            browserVersion: this.detectBrowserVersion(userAgent),
            
            // Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ´ØºÙŠÙ„
            os: this.detectOS(userAgent),
            osVersion: this.detectOSVersion(userAgent),
            
            // Ø§Ù„Ø¬Ù‡Ø§Ø²
            device: this.detectDevice(userAgent),
            deviceType: this.detectDeviceType(userAgent),
            
            // Ø¥Ù…ÙƒØ§Ù†ÙŠØ§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²
            screenResolution: {
                width: screen.width,
                height: screen.height,
                availWidth: screen.availWidth,
                availHeight: screen.availHeight
            },
            colorDepth: screen.colorDepth,
            pixelRatio: window.devicePixelRatio || 1,
            
            // Ø§Ù„Ù„ØºØ§Øª
            language: navigator.language,
            languages: navigator.languages || [navigator.language],
            
            // Ø§Ù„ÙˆÙ‚Øª
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            timezoneOffset: new Date().getTimezoneOffset(),
            
            // Ø¥Ø¶Ø§ÙØ§Øª
            cookiesEnabled: navigator.cookieEnabled,
            javaEnabled: navigator.javaEnabled ? navigator.javaEnabled() : false,
            pdfViewerEnabled: navigator.pdfViewerEnabled || false,
            
            // Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø©
            hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
            deviceMemory: navigator.deviceMemory || 'unknown',
            
            // Ø§Ù„Ø§ØªØµØ§Ù„
            connection: this.getConnectionInfo(),
            
            // Ø¥Ù…ÙƒØ§Ù†ÙŠØ§Øª Ø§Ù„Ù„Ù…Ø³
            touchSupport: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
            maxTouchPoints: navigator.maxTouchPoints || 0,
            
            // Ø§Ù„ØªØ§Ø±ÙŠØ®
            timestamp: new Date().toISOString()
        };
        
        console.log('ğŸ“± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²:', this.deviceInfo);
    }
    
    detectBrowser(userAgent) {
        if (userAgent.includes('Firefox')) return 'Firefox';
        if (userAgent.includes('Chrome')) return 'Chrome';
        if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) return 'Safari';
        if (userAgent.includes('Edge')) return 'Edge';
        if (userAgent.includes('MSIE') || userAgent.includes('Trident/')) return 'Internet Explorer';
        if (userAgent.includes('Opera') || userAgent.includes('OPR/')) return 'Opera';
        return 'Unknown';
    }
    
    detectBrowserVersion(userAgent) {
        const browsers = [
            { name: 'Firefox', regex: /Firefox\/([\d.]+)/ },
            { name: 'Chrome', regex: /Chrome\/([\d.]+)/ },
            { name: 'Safari', regex: /Version\/([\d.]+).*Safari/ },
            { name: 'Edge', regex: /Edge\/([\d.]+)/ },
            { name: 'IE', regex: /MSIE ([\d.]+)/ },
            { name: 'IE', regex: /Trident\/.*rv:([\d.]+)/ },
            { name: 'Opera', regex: /OPR\/([\d.]+)/ },
            { name: 'Opera', regex: /Opera\/([\d.]+)/ }
        ];
        
        for (const browser of browsers) {
            const match = userAgent.match(browser.regex);
            if (match) return match[1];
        }
        
        return 'Unknown';
    }
    
    detectOS(userAgent) {
        if (userAgent.includes('Windows')) return 'Windows';
        if (userAgent.includes('Mac OS')) return 'macOS';
        if (userAgent.includes('Linux')) return 'Linux';
        if (userAgent.includes('Android')) return 'Android';
        if (userAgent.includes('iOS') || userAgent.includes('iPhone') || userAgent.includes('iPad')) return 'iOS';
        return 'Unknown';
    }
    
    detectOSVersion(userAgent) {
        const osVersions = [
            { os: 'Windows', regex: /Windows NT ([\d.]+)/ },
            { os: 'macOS', regex: /Mac OS X ([\d_.]+)/ },
            { os: 'Android', regex: /Android ([\d.]+)/ },
            { os: 'iOS', regex: /OS ([\d_.]+) like Mac OS X/ }
        ];
        
        for (const os of osVersions) {
            const match = userAgent.match(os.regex);
            if (match) return match[1].replace(/_/g, '.');
        }
        
        return 'Unknown';
    }
    
    detectDevice(userAgent) {
        if (userAgent.includes('Mobile')) return 'Mobile';
        if (userAgent.includes('Tablet')) return 'Tablet';
        
        // Ø§ÙƒØªØ´Ø§Ù Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
        if (screen.width < 768) return 'Mobile';
        if (screen.width >= 768 && screen.width < 1024) return 'Tablet';
        return 'Desktop';
    }
    
    detectDeviceType(userAgent) {
        const devices = [
            { type: 'iPhone', regex: /iPhone/ },
            { type: 'iPad', regex: /iPad/ },
            { type: 'Samsung', regex: /Samsung/ },
            { type: 'Huawei', regex: /Huawei/ },
            { type: 'Xiaomi', regex: /Xiaomi/ },
            { type: 'Motorola', regex: /Motorola/ },
            { type: 'LG', regex: /LG/ },
            { type: 'Sony', regex: /Sony/ }
        ];
        
        for (const device of devices) {
            if (userAgent.match(device.regex)) return device.type;
        }
        
        return 'Unknown';
    }
    
    getConnectionInfo() {
        const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
        
        if (connection) {
            return {
                effectiveType: connection.effectiveType || 'unknown',
                downlink: connection.downlink || 'unknown',
                rtt: connection.rtt || 'unknown',
                saveData: connection.saveData || false,
                type: connection.type || 'unknown'
            };
        }
        
        return {
            effectiveType: 'unknown',
            downlink: 'unknown',
            rtt: 'unknown',
            saveData: false,
            type: 'unknown'
        };
    }
    
    // ====== Ø¬Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ© ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ ======
    async collectNetworkInfo() {
        try {
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ IP
            const ipResponse = await fetch('https://api.ipify.org?format=json');
            const ipData = await ipResponse.json();
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹
            const locationResponse = await fetch(`http://ip-api.com/json/${ipData.ip}?fields=country,countryCode,region,regionName,city,zip,lat,lon,timezone,isp,org,as,query`);
            const locationData = await locationResponse.json();
            
            this.locationInfo = {
                ip: ipData.ip,
                country: locationData.country || 'Unknown',
                countryCode: locationData.countryCode || 'Unknown',
                region: locationData.regionName || 'Unknown',
                city: locationData.city || 'Unknown',
                zip: locationData.zip || 'Unknown',
                coordinates: {
                    latitude: locationData.lat || 0,
                    longitude: locationData.lon || 0
                },
                timezone: locationData.timezone || 'Unknown',
                isp: locationData.isp || 'Unknown',
                organization: locationData.org || 'Unknown',
                as: locationData.as || 'Unknown'
            };
            
            console.log('ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹:', this.locationInfo);
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ©:', error);
            
            this.locationInfo = {
                ip: 'Unknown',
                country: 'Unknown',
                countryCode: 'Unknown',
                region: 'Unknown',
                city: 'Unknown',
                zip: 'Unknown',
                coordinates: { latitude: 0, longitude: 0 },
                timezone: 'Unknown',
                isp: 'Unknown',
                organization: 'Unknown',
                as: 'Unknown'
            };
        }
    }
    
    // ====== ØªØªØ¨Ø¹ Ø§Ù„Ø³Ù„ÙˆÙƒ ======
    startTracking() {
        this.isTracking = true;
        this.trackingStartTime = Date.now();
        
        // ØªØªØ¨Ø¹ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
        this.trackPageView();
        
        // ØªØªØ¨Ø¹ Ø§Ù„ÙˆÙ‚Øª Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
        this.trackTimeOnPage();
        
        // ØªØªØ¨Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ±
        this.trackScroll();
        
        // ØªØªØ¨Ø¹ Ø§Ù„Ù†Ù‚Ø±Ø§Øª
        this.trackClicks();
        
        // ØªØªØ¨Ø¹ Ø§Ù„ÙƒØªØ§Ø¨Ø©
        this.trackTyping();
        
        // ØªØªØ¨Ø¹ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
        this.trackResize();
        
        console.log('ğŸ¯ Ø¨Ø¯Ø£ ØªØªØ¨Ø¹ Ø³Ù„ÙˆÙƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
    }
    
    trackPageView() {
        const pageData = {
            type: 'pageview',
            url: window.location.href,
            referrer: document.referrer || 'direct',
            title: document.title,
            timestamp: new Date().toISOString(),
            sessionId: this.sessionId
        };
        
        this.behaviorData.push(pageData);
        this.saveBehaviorData(pageData);
    }
    
    trackTimeOnPage() {
        this.pageStartTime = Date.now();
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', () => {
            const timeSpent = Date.now() - this.pageStartTime;
            
            const timeData = {
                type: 'time_spent',
                timeSpent: timeSpent,
                sessionDuration: Date.now() - this.trackingStartTime,
                timestamp: new Date().toISOString(),
                sessionId: this.sessionId
            };
            
            this.behaviorData.push(timeData);
            this.sendBehaviorData(timeData);
        });
    }
    
    trackScroll() {
        let lastScrollPosition = window.scrollY;
        let scrollTimeout;
        
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            
            scrollTimeout = setTimeout(() => {
                const scrollDepth = (window.scrollY / document.body.scrollHeight) * 100;
                
                const scrollData = {
                    type: 'scroll',
                    scrollPosition: window.scrollY,
                    scrollDepth: Math.round(scrollDepth),
                    documentHeight: document.body.scrollHeight,
                    viewportHeight: window.innerHeight,
                    timestamp: new Date().toISOString(),
                    sessionId: this.sessionId
                };
                
                this.behaviorData.push(scrollData);
                
                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù‡Ø§Ù…Ø© ÙÙ‚Ø·
                if (scrollDepth % 25 === 0) { // ÙƒÙ„ 25%
                    this.saveBehaviorData(scrollData);
                }
            }, 500);
        });
    }
    
    trackClicks() {
        let clickCount = 0;
        
        document.addEventListener('click', (event) => {
            clickCount++;
            
            const target = event.target;
            const elementData = {
                tag: target.tagName,
                id: target.id || 'none',
                className: target.className || 'none',
                text: target.textContent?.substring(0, 100) || 'none',
                href: target.href || 'none'
            };
            
            const clickData = {
                type: 'click',
                clickNumber: clickCount,
                element: elementData,
                position: {
                    x: event.clientX,
                    y: event.clientY,
                    pageX: event.pageX,
                    pageY: event.pageY
                },
                timestamp: new Date().toISOString(),
                sessionId: this.sessionId
            };
            
            this.behaviorData.push(clickData);
            
            // Ø­ÙØ¸ ÙƒÙ„ 10 Ù†Ù‚Ø±Ø§Øª ÙÙ‚Ø·
            if (clickCount % 10 === 0) {
                this.saveBehaviorData(clickData);
            }
        }, { capture: true });
    }
    
    trackTyping() {
        let typingStartTime = null;
        let typingData = [];
        
        document.addEventListener('focusin', (event) => {
            if (event.target.matches('input, textarea')) {
                typingStartTime = Date.now();
            }
        });
        
        document.addEventListener('focusout', (event) => {
            if (event.target.matches('input, textarea') && typingStartTime) {
                const typingDuration = Date.now() - typingStartTime;
                
                const typeData = {
                    type: 'typing',
                    fieldType: event.target.type,
                    fieldName: event.target.name || 'unknown',
                    typingDuration: typingDuration,
                    valueLength: event.target.value.length,
                    timestamp: new Date().toISOString(),
                    sessionId: this.sessionId
                };
                
                this.behaviorData.push(typeData);
                this.saveBehaviorData(typeData);
                
                typingStartTime = null;
            }
        });
    }
    
    trackResize() {
        let resizeTimeout;
        
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            
            resizeTimeout = setTimeout(() => {
                const resizeData = {
                    type: 'resize',
                    windowSize: {
                        width: window.innerWidth,
                        height: window.innerHeight
                    },
                    screenSize: {
                        width: screen.width,
                        height: screen.height
                    },
                    timestamp: new Date().toISOString(),
                    sessionId: this.sessionId
                };
                
                this.behaviorData.push(resizeData);
                this.saveBehaviorData(resizeData);
            }, 500);
        });
    }
    
    // ====== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø£Ø­Ø¯Ø§Ø« ======
    setupEventListeners() {
        // ØªØªØ¨Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        window.addEventListener('error', (event) => {
            this.trackError(event);
        });
        
        // ØªØªØ¨Ø¹ Ø§Ù„ÙˆØ¹ÙˆØ¯ Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©
        window.addEventListener('unhandledrejection', (event) => {
            this.trackPromiseRejection(event);
        });
        
        // ØªØªØ¨Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„Ø§ØªØµØ§Ù„
        window.addEventListener('online', () => {
            this.trackConnectionChange('online');
        });
        
        window.addEventListener('offline', () => {
            this.trackConnectionChange('offline');
        });
        
        // ØªØªØ¨Ø¹ ØªØºÙŠÙŠØ± Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨
        document.addEventListener('visibilitychange', () => {
            this.trackVisibilityChange();
        });
    }
    
    trackError(errorEvent) {
        const errorData = {
            type: 'error',
            errorType: 'runtime',
            message: errorEvent.message,
            filename: errorEvent.filename,
            lineno: errorEvent.lineno,
            colno: errorEvent.colno,
            timestamp: new Date().toISOString(),
            sessionId: this.sessionId
        };
        
        this.behaviorData.push(errorData);
        this.saveBehaviorData(errorData);
    }
    
    trackPromiseRejection(event) {
        const rejectionData = {
            type: 'error',
            errorType: 'promise_rejection',
            reason: event.reason?.message || event.reason,
            timestamp: new Date().toISOString(),
            sessionId: this.sessionId
        };
        
        this.behaviorData.push(rejectionData);
        this.saveBehaviorData(rejectionData);
    }
    
    trackConnectionChange(status) {
        const connectionData = {
            type: 'connection_change',
            status: status,
            timestamp: new Date().toISOString(),
            sessionId: this.sessionId
        };
        
        this.behaviorData.push(connectionData);
        this.saveBehaviorData(connectionData);
    }
    
    trackVisibilityChange() {
        const visibilityData = {
            type: 'visibility_change',
            state: document.visibilityState,
            timestamp: new Date().toISOString(),
            sessionId: this.sessionId
        };
        
        this.behaviorData.push(visibilityData);
        this.saveBehaviorData(visibilityData);
    }
    
    // ====== Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ======
    saveBehaviorData(data) {
        try {
            // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹
            let savedData = JSON.parse(localStorage.getItem('behavior_data') || '[]');
            savedData.push(data);
            
            // Ø­ÙØ¸ ÙÙ‚Ø· Ø¢Ø®Ø± 1000 Ø­Ø¯Ø«
            if (savedData.length > 1000) {
                savedData = savedData.slice(-1000);
            }
            
            localStorage.setItem('behavior_data', JSON.stringify(savedData));
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ù„ÙˆÙƒ:', error);
        }
    }
    
    // ====== Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ======
    async sendInitialData() {
        const initialData = {
            type: 'visitor_initial',
            visitorId: this.visitorId,
            sessionId: this.sessionId,
            deviceInfo: this.deviceInfo,
            locationInfo: this.locationInfo,
            visitInfo: {
                visits: parseInt(localStorage.getItem('visitor_visits') || '1'),
                firstVisit: localStorage.getItem('first_visit'),
                lastVisit: localStorage.getItem('last_visit')
            },
            timestamp: new Date().toISOString()
        };
        
        // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹
        this.saveVisitorData(initialData);
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Telegram
        await this.sendToTelegram(initialData);
    }
    
    async sendBehaviorData(data) {
        const behaviorData = {
            type: 'visitor_behavior',
            visitorId: this.visitorId,
            sessionId: this.sessionId,
            behavior: data,
            timestamp: new Date().toISOString()
        };
        
        // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹
        this.saveBehaviorData(behaviorData);
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙ‚Ø·
        if (this.isImportantEvent(data)) {
            await this.sendToTelegram(behaviorData);
        }
    }
    
    isImportantEvent(data) {
        const importantTypes = [
            'pageview',
            'time_spent',
            'error',
            'promise_rejection'
        ];
        
        return importantTypes.includes(data.type) || 
               (data.type === 'click' && data.clickNumber % 50 === 0) ||
               (data.type === 'scroll' && data.scrollDepth >= 75);
    }
    
    async sendToTelegram(data) {
        try {
            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Telegram
            const botToken = localStorage.getItem('telegram_bot_token') || '';
            const chatId = localStorage.getItem('telegram_chat_id') || '';
            
            if (!botToken || !chatId) {
                console.warn('âš ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Telegram ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©');
                return;
            }
            
            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            const message = this.formatTelegramMessage(data);
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: message,
                    parse_mode: 'HTML',
                    disable_web_page_preview: true
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ø¥Ù„Ù‰ Telegram');
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Telegram:', error);
            this.saveFailedData(data);
        }
    }
    
    formatTelegramMessage(data) {
        let message = '';
        
        switch (data.type) {
            case 'visitor_initial':
                message = `
ğŸ‘¤ <b>Ø²Ø§Ø¦Ø± Ø¬Ø¯ÙŠØ¯</b>

ğŸ†” <b>Ù…Ø¹Ø±Ù Ø§Ù„Ø²Ø§Ø¦Ø±:</b> <code>${data.visitorId}</code>
ğŸŒ <b>Ø§Ù„Ø¨Ù„Ø¯:</b> ${data.locationInfo.country}
ğŸ™ï¸ <b>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</b> ${data.locationInfo.city}
ğŸ“± <b>Ø§Ù„Ø¬Ù‡Ø§Ø²:</b> ${data.deviceInfo.device} - ${data.deviceInfo.os}
ğŸŒ <b>Ø§Ù„Ù…ØªØµÙØ­:</b> ${data.deviceInfo.browser}
ğŸ“¡ <b>Ø§Ù„Ø§ØªØµØ§Ù„:</b> ${data.deviceInfo.connection.effectiveType}
ğŸ“Š <b>Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø±Ù‚Ù…:</b> ${data.visitInfo.visits}
ğŸ• <b>Ø§Ù„ÙˆÙ‚Øª:</b> ${new Date().toLocaleString('ar-EG')}
                `;
                break;
                
            case 'visitor_behavior':
                switch (data.behavior.type) {
                    case 'pageview':
                        message = `
ğŸ“„ <b>Ø²ÙŠØ§Ø±Ø© ØµÙØ­Ø©</b>

ğŸ‘¤ <b>Ø§Ù„Ø²Ø§Ø¦Ø±:</b> ${data.visitorId}
ğŸ”— <b>Ø§Ù„ØµÙØ­Ø©:</b> ${data.behavior.url}
ğŸ·ï¸ <b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${data.behavior.title}
ğŸ“Š <b>Ø§Ù„Ù…ØµØ¯Ø±:</b> ${data.behavior.referrer}
                        `;
                        break;
                        
                    case 'error':
                        message = `
âŒ <b>Ø­Ø¯Ø« Ø®Ø·Ø£</b>

ğŸ‘¤ <b>Ø§Ù„Ø²Ø§Ø¦Ø±:</b> ${data.visitorId}
ğŸ“ <b>Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</b> ${data.behavior.message}
ğŸ“„ <b>Ø§Ù„Ù…Ù„Ù:</b> ${data.behavior.filename}
ğŸ“ <b>Ø§Ù„Ø³Ø·Ø±:</b> ${data.behavior.lineno}:${data.behavior.colno}
                        `;
                        break;
                        
                    case 'time_spent':
                        const minutes = Math.floor(data.behavior.timeSpent / 60000);
                        const seconds = Math.floor((data.behavior.timeSpent % 60000) / 1000);
                        
                        message = `
â±ï¸ <b>ÙˆÙ‚Øª Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©</b>

ğŸ‘¤ <b>Ø§Ù„Ø²Ø§Ø¦Ø±:</b> ${data.visitorId}
ğŸ• <b>Ø§Ù„Ù…Ø¯Ø©:</b> ${minutes} Ø¯Ù‚ÙŠÙ‚Ø© ${seconds} Ø«Ø§Ù†ÙŠØ©
                        `;
                        break;
                }
                break;
        }
        
        return message.trim();
    }
    
    saveVisitorData(data) {
        try {
            let visitors = JSON.parse(localStorage.getItem('tracked_visitors') || '[]');
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
            const existingVisitorIndex = visitors.findIndex(v => v.visitorId === data.visitorId);
            
            if (existingVisitorIndex !== -1) {
                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²Ø§Ø¦Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
                visitors[existingVisitorIndex] = {
                    ...visitors[existingVisitorIndex],
                    ...data,
                    lastSeen: new Date().toISOString(),
                    sessionsCount: (visitors[existingVisitorIndex].sessionsCount || 1) + 1
                };
            } else {
                // Ø¥Ø¶Ø§ÙØ© Ø²Ø§Ø¦Ø± Ø¬Ø¯ÙŠØ¯
                visitors.push({
                    ...data,
                    firstSeen: new Date().toISOString(),
                    lastSeen: new Date().toISOString(),
                    sessionsCount: 1
                });
            }
            
            // Ø­ÙØ¸ ÙÙ‚Ø· Ø¢Ø®Ø± 1000 Ø²Ø§Ø¦Ø±
            if (visitors.length > 1000) {
                visitors = visitors.slice(-1000);
            }
            
            localStorage.setItem('tracked_visitors', JSON.stringify(visitors));
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²ÙˆØ§Ø±:', error);
        }
    }
    
    saveFailedData(data) {
        try {
            let failedData = JSON.parse(localStorage.getItem('failed_tracking_data') || '[]');
            failedData.push({
                data: data,
                timestamp: new Date().toISOString(),
                retryCount: 0
            });
            
            // Ø­ÙØ¸ ÙÙ‚Ø· Ø¢Ø®Ø± 100 Ø­Ø¯Ø« ÙØ§Ø´Ù„
            if (failedData.length > 100) {
                failedData = failedData.slice(-100);
            }
            
            localStorage.setItem('failed_tracking_data', JSON.stringify(failedData));
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©:', error);
        }
    }
    
    // ====== Ø¯ÙˆØ§Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø¹Ø§Ù… ======
    getVisitorInfo() {
        return {
            visitorId: this.visitorId,
            sessionId: this.sessionId,
            deviceInfo: this.deviceInfo,
            locationInfo: this.locationInfo,
            visitCount: parseInt(localStorage.getItem('visitor_visits') || '1'),
            firstVisit: localStorage.getItem('first_visit'),
            lastVisit: localStorage.getItem('last_visit')
        };
    }
    
    getBehaviorSummary() {
        const behaviors = this.behaviorData;
        
        return {
            totalEvents: behaviors.length,
            pageViews: behaviors.filter(b => b.type === 'pageview').length,
            clicks: behaviors.filter(b => b.type === 'click').length,
            scrolls: behaviors.filter(b => b.type === 'scroll').length,
            errors: behaviors.filter(b => b.type === 'error').length,
            averageTimeOnPage: this.calculateAverageTimeOnPage()
        };
    }
    
    calculateAverageTimeOnPage() {
        const timeEvents = this.behaviorData.filter(b => b.type === 'time_spent');
        if (timeEvents.length === 0) return 0;
        
        const totalTime = timeEvents.reduce((sum, event) => sum + event.timeSpent, 0);
        return Math.round(totalTime / timeEvents.length);
    }
    
    // ====== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ======
    formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    getCurrentSessionDuration() {
        return Date.now() - this.trackingStartTime;
    }
    
    // ====== Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªØªØ¨Ø¹ ======
    stopTracking() {
        this.isTracking = false;
        console.log('ğŸ›‘ ØªÙˆÙ‚Ù ØªØªØ¨Ø¹ Ø³Ù„ÙˆÙƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
    }
    
    resumeTracking() {
        if (!this.isTracking) {
            this.isTracking = true;
            console.log('â–¶ï¸ Ø§Ø³ØªØ¦Ù†Ø§Ù ØªØªØ¨Ø¹ Ø³Ù„ÙˆÙƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
        }
    }
    
    clearTrackingData() {
        this.behaviorData = [];
        localStorage.removeItem('behavior_data');
        console.log('ğŸ—‘ï¸ ØªÙ… Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØªØ¨Ø¹');
    }
    
    // ====== Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØµØ¯ÙŠØ± ======
    exportVisitorData() {
        const data = {
            visitorInfo: this.getVisitorInfo(),
            behaviorSummary: this.getBehaviorSummary(),
            rawBehaviorData: this.behaviorData.slice(-100) // Ø¢Ø®Ø± 100 Ø­Ø¯Ø«
        };
        
        return JSON.stringify(data, null, 2);
    }
    
    downloadVisitorData() {
        const data = this.exportVisitorData();
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `visitor_${this.visitorId}_${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
}

// ====== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØªØ¨Ø¹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ======
let visitorTracker = null;

document.addEventListener('DOMContentLoaded', function() {
    try {
        visitorTracker = new VisitorTracker();
        console.log('ğŸ¯ Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø§Ù„Ø²ÙˆØ§Ø± Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„!');
        
        // ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒØ§Ø¦Ù† Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù…
        window.VisitorTracker = visitorTracker;
        
    } catch (error) {
        console.error('âŒ ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØªØ¨Ø¹:', error);
    }
});

// ====== ØªØµØ¯ÙŠØ± Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù… ======
window.TRACKER = {
    getTracker: () => visitorTracker,
    getVisitorInfo: () => visitorTracker?.getVisitorInfo() || {},
    exportData: () => visitorTracker?.exportVisitorData() || '{}',
    downloadData: () => visitorTracker?.downloadVisitorData(),
    stopTracking: () => visitorTracker?.stopTracking(),
    resumeTracking: () => visitorTracker?.resumeTracking(),
    clearData: () => visitorTracker?.clearTrackingData()
};

console.log('âœ… tracker.js ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!');